<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hubstaff Client Log Analyzer</title>
  <style>
    :root {
      --bg: #0f0a1a; --panel: #1a1025; --card: #12081c; --text: #e5e7eb;
      --muted: #a78bba; --accent: #a855f7; --accent-dim: #7c3aed; --warn: #f59e0b; --danger: #ef4444;
      --success: #22c55e; --info: #3b82f6; --border: #2d1f3d; --link: #c084fc;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

    header { padding: 20px; border-bottom: 1px solid var(--border); background: linear-gradient(135deg, var(--panel) 0%, #1f1030 100%); }
    header h1 { font-size: 18px; margin-bottom: 4px; color: var(--link); }
    header p { font-size: 12px; color: var(--muted); }

    main { padding: 16px; max-width: 1400px; margin: 0 auto; }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 16px; }

    .controls { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }

    button { background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 8px 14px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    button:hover { border-color: var(--accent-dim); background: #251535; }
    button.primary { background: linear-gradient(135deg, var(--accent-dim) 0%, var(--accent) 100%); border-color: var(--accent); }
    button.primary:hover { opacity: 0.9; }

    textarea { width: 100%; height: 150px; background: #050208; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 11px; resize: vertical; }
    textarea:focus { outline: none; border-color: var(--accent-dim); }

    .status { font-size: 12px; color: var(--muted); margin-left: 8px; }
    .status.success { color: var(--success); }
    .status.error { color: var(--danger); }

    .toggle-row { display: flex; align-items: center; gap: 16px; margin-top: 10px; font-size: 13px; color: var(--muted); flex-wrap: wrap; }
    .toggle-row label { display: flex; align-items: center; gap: 6px; cursor: pointer; }
    .toggle-row input[type="checkbox"] { accent-color: var(--accent); }
    .help-link { color: var(--accent); text-decoration: underline; cursor: pointer; margin-left: auto; }

    .filter-row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .filter-btn { padding: 4px 10px; font-size: 11px; border-radius: 20px; }
    .filter-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .kpi { background: linear-gradient(135deg, var(--panel) 0%, #1a1028 100%); border: 1px solid var(--border); border-radius: 10px; padding: 14px; }
    .kpi-label { font-size: 11px; color: var(--muted); font-weight: 600; margin-bottom: 6px; }
    .kpi-value { font-size: 22px; font-weight: 700; color: var(--link); }
    .kpi-value.danger { color: var(--danger); }
    .kpi-value.warn { color: var(--warn); }
    .kpi-value.success { color: var(--success); }

    .section-title { font-size: 13px; color: var(--muted); margin-bottom: 10px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .section-title span { color: var(--accent); }

    .table-wrap { max-height: 400px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th, td { padding: 8px 10px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--panel); color: var(--muted); font-weight: 600; position: sticky; top: 0; z-index: 10; }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(168,85,247,0.05); }

    .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
    .tag.error { background: rgba(239,68,68,0.15); color: var(--danger); }
    .tag.warn { background: rgba(245,158,11,0.15); color: var(--warn); }
    .tag.info { background: rgba(59,130,246,0.15); color: var(--info); }
    .tag.success { background: rgba(34,197,94,0.15); color: var(--success); }
    .tag.audit { background: rgba(168,85,247,0.15); color: var(--accent); }
    .tag.trace { background: rgba(107,114,128,0.15); color: #9ca3af; }
    .tag.debug { background: rgba(107,114,128,0.1); color: #6b7280; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }

    .log-line { font-family: monospace; font-size: 11px; line-height: 1.6; word-break: break-all; }
    .log-line .ts { color: var(--muted); }
    .log-line .level { font-weight: 600; }
    .log-line .src { color: var(--accent-dim); }
    .log-line .msg { color: var(--text); }

    .category-header { background: var(--panel); padding: 10px 12px; font-size: 12px; font-weight: 600; color: var(--link); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .category-header:hover { background: #251535; }
    .category-count { background: var(--accent-dim); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
    .category-content { max-height: 300px; overflow-y: auto; }
    .category-content.collapsed { display: none; }

    .event-item { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 12px; }
    .event-item:last-child { border-bottom: none; }
    .event-item:hover { background: rgba(168,85,247,0.05); }
    .event-time { color: var(--muted); font-size: 11px; margin-bottom: 4px; }
    .event-detail { color: var(--text); }
    .event-context { color: var(--muted); font-size: 10px; margin-top: 4px; font-family: monospace; }

    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1001; align-items: center; justify-content: center; }
    .modal-overlay.visible { display: flex; }
    .modal { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; padding: 24px; }
    .modal h2 { color: var(--link); margin-bottom: 16px; font-size: 18px; }
    .modal h3 { color: var(--accent); margin: 20px 0 10px; font-size: 14px; border-bottom: 1px solid var(--border); padding-bottom: 6px; }
    .modal p, .modal li { font-size: 13px; color: var(--muted); line-height: 1.6; margin-bottom: 8px; }
    .modal code { background: var(--card); padding: 2px 6px; border-radius: 4px; font-size: 12px; color: var(--accent); }
    .close-btn { float: right; background: var(--panel); border: 1px solid var(--border); color: var(--text); padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
    .close-btn:hover { border-color: var(--accent-dim); }

    .search-box { display: flex; gap: 8px; margin-bottom: 12px; }
    .search-box input { flex: 1; background: #050208; border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: var(--text); font-size: 13px; }
    .search-box input:focus { outline: none; border-color: var(--accent-dim); }
    .search-box input::placeholder { color: #4a3a5a; }

    .highlight { background: rgba(245,158,11,0.3) !important; }

    .timeline-section { margin-bottom: 16px; }
    .timeline-header { display: flex; align-items: center; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; }
    .timeline-legend { font-size: 11px; color: var(--muted); display: flex; gap: 10px; flex-wrap: wrap; }
    .legend-toggle { display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 3px 8px; border-radius: 4px; transition: all 0.2s; user-select: none; }
    .legend-toggle:hover { background: rgba(168,85,247,0.1); }
    .legend-toggle input { accent-color: var(--accent); cursor: pointer; }
    .legend-toggle.disabled { opacity: 0.4; }
    .legend-box { width: 12px; height: 12px; border-radius: 2px; }

    .zoom-controls { display: flex; align-items: center; gap: 8px; margin-left: auto; background: var(--panel); padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border); }
    .zoom-controls label { font-size: 11px; color: var(--muted); }
    .zoom-controls input[type=range] { width: 100px; cursor: pointer; accent-color: var(--accent); }

    .timeline-container { background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; padding: 16px; overflow-x: auto; position: relative; }
    .timeline-content { position: relative; min-width: 100%; }
    .timeline-track { position: relative; height: 28px; background: rgba(255,255,255,0.02); border-radius: 4px; margin-bottom: 8px; border: 1px solid var(--border); transition: all 0.2s; }
    .timeline-track.hidden { display: none; }
    .timeline-label { font-size: 10px; color: var(--muted); margin-bottom: 4px; font-weight: 600; text-transform: uppercase; display: flex; justify-content: space-between; transition: all 0.2s; }
    .timeline-label.hidden { display: none; }
    .timeline-label .count { color: var(--accent); }

    .t-marker { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 10px; height: 10px; border-radius: 50%; cursor: pointer; transition: transform 0.15s; z-index: 10; }
    .t-marker:hover { transform: translate(-50%, -50%) scale(1.5); z-index: 20; }
    .t-marker.error { background: var(--danger); box-shadow: 0 0 6px var(--danger); }
    .t-marker.warn { background: var(--warn); box-shadow: 0 0 6px var(--warn); }
    .t-marker.screenshot { background: var(--accent); box-shadow: 0 0 6px var(--accent); }
    .t-marker.network { background: var(--info); box-shadow: 0 0 6px var(--info); }
    .t-marker.location { background: #10b981; box-shadow: 0 0 6px #10b981; }
    .t-marker.tracking { background: var(--link); box-shadow: 0 0 6px var(--link); }

    .timeline-time-axis { display: flex; justify-content: space-between; font-size: 9px; color: var(--muted); margin-top: 8px; padding: 0 4px; }

    .info-box { position: fixed; background: var(--panel); border: 1px solid var(--accent); border-radius: 10px; padding: 14px; z-index: 1000; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.6); min-width: 220px; max-width: 350px; }
    .info-box h4 { color: var(--accent); font-size: 13px; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
    .info-box p { font-size: 12px; color: var(--text); margin: 4px 0; line-height: 1.5; }
    .info-box .label { color: var(--muted); }
    .info-box .msg { font-family: monospace; font-size: 10px; background: var(--bg); padding: 8px; border-radius: 4px; margin-top: 8px; max-height: 100px; overflow-y: auto; word-break: break-all; }

    .summary-item { padding: 12px; margin-bottom: 10px; border-radius: 8px; border-left: 3px solid var(--border); }
    .summary-item.critical { background: rgba(239,68,68,0.1); border-left-color: var(--danger); }
    .summary-item.warning { background: rgba(245,158,11,0.1); border-left-color: var(--warn); }
    .summary-item.info { background: rgba(168,85,247,0.1); border-left-color: var(--accent); }
    .summary-item.success { background: rgba(34,197,94,0.1); border-left-color: var(--success); }
    .summary-item h4 { font-size: 13px; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; }
    .summary-item p { font-size: 12px; color: var(--muted); margin: 4px 0; line-height: 1.5; }
    .summary-item .action { font-size: 11px; color: var(--link); margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border); }
    .summary-item .tech-detail { font-size: 10px; color: #666; font-family: monospace; margin-top: 6px; padding: 6px; background: rgba(0,0,0,0.2); border-radius: 4px; display: none; }
    .summary-item .tech-detail.visible { display: block; }
    .summary-item .show-tech { font-size: 10px; color: var(--muted); cursor: pointer; text-decoration: underline; margin-left: 8px; }

    .plain-explanation { font-size: 11px; color: var(--accent); margin-top: 4px; padding: 6px 10px; background: rgba(168,85,247,0.1); border-radius: 4px; border-left: 2px solid var(--accent); }

    footer { text-align: center; padding: 20px; border-top: 1px solid var(--border); margin-top: 20px; font-size: 12px; color: var(--muted); }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent-dim); }
  </style>
</head>
<body>
  <header>
    <h1>üîÆ Hubstaff Client Log Analyzer</h1>
    <p>Analyze hubstaff.log files to diagnose tracking issues, crashes, network errors, and more.</p>
    <p style="font-size:11px; color:var(--success); margin-top:4px;">üîí Privacy: All analysis happens in your browser. No data is sent anywhere.</p>
  </header>

  <main>
    <div class="card">
      <div class="controls">
        <button class="primary" id="analyzeBtn">üîç Analyze</button>
        <button id="clearBtn">Clear</button>
        <span class="status" id="status"></span>
      </div>
      <textarea id="logInput" placeholder="Paste raw hubstaff.log contents here - noise will be filtered automatically..."></textarea>
      <div class="toggle-row">
        <label><input type="checkbox" id="autoFilter" checked> Auto-filter noise</label>
        <label><input type="checkbox" id="plainMode" checked> üéØ Plain English mode</label>
        <label><input type="checkbox" id="showDebug"> Show DEBUG level</label>
        <label><input type="checkbox" id="showTrace"> Show TRACE level</label>
        <span class="help-link" id="helpBtn">Help & Info</span>
      </div>
      <div id="filterStats" style="margin-top:8px;font-size:11px;color:var(--muted);display:none;">
        <span id="filterStatsText"></span>
      </div>
      <div class="search-box" style="margin-top:12px;">
        <input type="text" id="searchInput" placeholder="Search logs (e.g., 'error', 'screenshot', 'URL:')...">
        <button id="searchBtn">Search</button>
        <button id="clearSearchBtn">Clear</button>
      </div>
    </div>

    <div class="kpis" id="kpiSection">
      <div class="kpi"><div class="kpi-label">Total Lines</div><div class="kpi-value" id="kpiTotal">0</div></div>
      <div class="kpi"><div class="kpi-label">Errors</div><div class="kpi-value danger" id="kpiErrors">0</div></div>
      <div class="kpi"><div class="kpi-label">Warnings</div><div class="kpi-value warn" id="kpiWarnings">0</div></div>
      <div class="kpi"><div class="kpi-label">Screenshots</div><div class="kpi-value" id="kpiScreenshots">0</div></div>
      <div class="kpi"><div class="kpi-label">Network Issues</div><div class="kpi-value warn" id="kpiNetwork">0</div></div>
      <div class="kpi"><div class="kpi-label">Time Span</div><div class="kpi-value" id="kpiTimeSpan">--</div></div>
    </div>

    <div class="card" id="summaryCard" style="display:none; border-left: 3px solid var(--accent);">
      <div class="section-title"><span>üìã</span> Quick Summary for Support</div>
      <div id="summaryContent"></div>
    </div>

    <div class="card timeline-section" id="timelineSection" style="display:none;">
      <div class="timeline-header">
        <div class="section-title" style="margin:0;"><span>üìä</span> Event Timeline</div>
        <div class="timeline-legend">
          <label class="legend-toggle"><input type="checkbox" id="togErrors" checked><div class="legend-box" style="background:var(--danger)"></div> Errors</label>
          <label class="legend-toggle"><input type="checkbox" id="togWarnings" checked><div class="legend-box" style="background:var(--warn)"></div> Warnings</label>
          <label class="legend-toggle"><input type="checkbox" id="togScreenshots" checked><div class="legend-box" style="background:var(--accent)"></div> Screenshots</label>
          <label class="legend-toggle"><input type="checkbox" id="togNetwork" checked><div class="legend-box" style="background:var(--info)"></div> Network</label>
          <label class="legend-toggle"><input type="checkbox" id="togLocation" checked><div class="legend-box" style="background:#10b981"></div> Location</label>
          <label class="legend-toggle"><input type="checkbox" id="togTracking" checked><div class="legend-box" style="background:var(--link)"></div> Tracking</label>
        </div>
        <div class="zoom-controls">
          <label>Zoom:</label>
          <input type="range" id="zoomSlider" min="1" max="20" value="1" step="0.5">
          <button id="resetZoom">Reset</button>
        </div>
      </div>
      <div class="timeline-container" id="timelineContainer">
        <div class="timeline-content" id="timelineContent">
          <div class="timeline-label" id="labelErrors">Errors <span class="count" id="tlErrorCount">0</span></div>
          <div class="timeline-track" id="trackErrors"></div>
          <div class="timeline-label" id="labelWarnings">Warnings <span class="count" id="tlWarnCount">0</span></div>
          <div class="timeline-track" id="trackWarnings"></div>
          <div class="timeline-label" id="labelScreenshots">Screenshots <span class="count" id="tlScreenCount">0</span></div>
          <div class="timeline-track" id="trackScreenshots"></div>
          <div class="timeline-label" id="labelNetwork">Network <span class="count" id="tlNetCount">0</span></div>
          <div class="timeline-track" id="trackNetwork"></div>
          <div class="timeline-label" id="labelLocation">Location <span class="count" id="tlLocCount">0</span></div>
          <div class="timeline-track" id="trackLocation"></div>
          <div class="timeline-label" id="labelTracking">Tracking <span class="count" id="tlTrackCount">0</span></div>
          <div class="timeline-track" id="trackTracking"></div>
          <div class="timeline-time-axis" id="timeAxis"></div>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="section-title"><span>üö®</span> Errors & Critical Issues</div>
        <div id="errorsSection">
          <div class="category-content" id="errorsList" style="max-height:350px;"></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title"><span>‚ö†Ô∏è</span> Warnings & Anomalies</div>
        <div id="warningsSection">
          <div class="category-content" id="warningsList" style="max-height:350px;"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><span>üì∏</span> Screenshots & Screen Capture</div>
      <div class="table-wrap" style="max-height:250px;">
        <table>
          <thead><tr><th>Time</th><th>Event</th><th>Details</th></tr></thead>
          <tbody id="screenshotsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><span>üåê</span> Network & API Activity</div>
      <div class="table-wrap" style="max-height:250px;">
        <table>
          <thead><tr><th>Time</th><th>Status</th><th>Details</th></tr></thead>
          <tbody id="networkBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><span>üìç</span> Locations & Job Sites</div>
      <div class="table-wrap" style="max-height:200px;">
        <table>
          <thead><tr><th>Time</th><th>Event</th><th>Details</th></tr></thead>
          <tbody id="locationsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><span>üñ•Ô∏è</span> URLs & Applications</div>
      <div class="table-wrap" style="max-height:250px;">
        <table>
          <thead><tr><th>Time</th><th>Type</th><th>Content</th></tr></thead>
          <tbody id="appsBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><span>‚è±Ô∏è</span> Time Tracking Events</div>
      <div class="table-wrap" style="max-height:250px;">
        <table>
          <thead><tr><th>Time</th><th>Event</th><th>Details</th></tr></thead>
          <tbody id="trackingBody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="section-title"><span>üîé</span> Search Results</div>
      <div class="table-wrap" style="max-height:300px;">
        <table>
          <thead><tr><th>Time</th><th>Level</th><th>Source</th><th>Message</th></tr></thead>
          <tbody id="searchBody"></tbody>
        </table>
      </div>
    </div>

    <footer>
      <span>Hubstaff Client Log Analyzer</span>
      <span style="margin:0 10px;">|</span>
      <span>For hubstaff.log analysis</span>
    </footer>
  </main>

  <div class="info-box" id="infoBox">
    <h4 id="infoTitle">Event Details</h4>
    <div id="infoContent"></div>
  </div>

  <div class="modal-overlay" id="helpModal">
    <div class="modal">
      <button class="close-btn" id="closeHelp">Close</button>
      <h2>üîÆ Client Log Analyzer Help</h2>
      
      <h3>What this tool analyzes</h3>
      <p>This analyzer is designed for <code>hubstaff.log</code> files (the detailed client logs), not audit.log files. It extracts and categorizes:</p>
      <ul>
        <li><strong>Errors & Crashes</strong> - [ERROR] level events, watchdog hits, helper crashes</li>
        <li><strong>Warnings</strong> - [WARN] level events, discarded time, anomalies</li>
        <li><strong>Screenshots</strong> - Capture events, uploads, failures</li>
        <li><strong>Network</strong> - API responses, connection issues, sync problems</li>
        <li><strong>Locations</strong> - Job site events, geofence entries/exits</li>
        <li><strong>URLs & Apps</strong> - Tracked applications and websites</li>
        <li><strong>Time Tracking</strong> - Resume, idle, discard events</li>
      </ul>

      <h3>Built-in Noise Filter</h3>
      <p>The analyzer has a built-in noise filter (enabled by default). It automatically removes routine log lines that don't help with debugging:</p>
      <ul>
        <li><code>WindowsInput.cpp</code> - Mouse/keyboard coordinates</li>
        <li><code>InputExtension.h</code> - Routine input tracking</li>
        <li><code>Heart beat</code> - Keep-alive messages</li>
        <li><code>Response: 200/201/204</code> - Successful API calls</li>
        <li><code>StorageIO.*Wrote</code> - Routine database writes (unless Location/TrackedActivity)</li>
        <li><code>Storage.h.*Read</code> - Routine reads</li>
      </ul>
      <p>Uncheck "Auto-filter noise" if you need to see all raw log lines.</p>

      <h3>Key things to look for</h3>
      <ul>
        <li><code>main_watchdog hit</code> - App is freezing/hanging</li>
        <li><code>Helper died</code> - Browser extension crashed</li>
        <li><code>Discard=</code> - Time was rejected</li>
        <li><code>Response: 4xx/5xx</code> - Server errors</li>
        <li><code>OS Memory</code> - Low memory warnings</li>
      </ul>

      <h3>Search tips</h3>
      <p>Use the search box to find specific patterns:</p>
      <ul>
        <li><code>error</code> - Find all error mentions</li>
        <li><code>URL:</code> - Find tracked URLs</li>
        <li><code>screenshot</code> - Find screenshot events</li>
        <li><code>Discard</code> - Find rejected time</li>
      </ul>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const pad = n => String(n).padStart(2, '0');

    let allLines = [];
    let parsedData = null;
    let timelineMin = null;
    let timelineDur = null;
    let selectedMarker = null;

    // === NOISE FILTER PATTERNS ===
    const NOISE_PATTERNS = [
      /WindowsInput\.cpp/,
      /InputExtension\.h/,
      /Heart beat\s*:/i,
      /Response:\s*200\b/,
      /Response:\s*201\b/,
      /Response:\s*204\b/,
      /Check CURL Response/i,
      /Storage\.h.*Read/i,
    ];

    const HELPER_CLIENT_PATTERN = /HelperClient\.cpp/;
    const HELPER_CLIENT_KEEP = /(URL:|APP:|TITLE:)/i;
    const STORAGE_IO_WROTE_PATTERN = /StorageIO.*Wrote/i;
    const STORAGE_IO_KEEP = /(Location|TrackedActivity)/i;

    const SIGNAL_PATTERNS = [
      /\[ERROR\]/i, /\[WARN\]/i, /\[AUDIT\]/i,
      /main_watchdog hit/i, /OS Memory/i, /Helper died/i, /Startup/i,
      /Discard=/i, /\bResume\b/i, /\bIdle\b/i,
      /Server Error/i, /Possible traffic issue/i,
      /Response:\s*4\d{2}/, /Response:\s*5\d{2}/,
      /Uploading Screen/i, /Capture Screen/i, /Wrote ScreenData/i,
      /feed:\s*sites/i, /LocationFeatureState/i, /LocationManager/i,
    ];

    const APP_GRABBER_PATTERN = /ApplicationGrabber/i;
    const APP_GRABBER_KEEP = /(URL:|TITLE:)/i;

    function isSignal(line) {
      for (const p of SIGNAL_PATTERNS) if (p.test(line)) return true;
      if (APP_GRABBER_PATTERN.test(line) && APP_GRABBER_KEEP.test(line)) return true;
      if (HELPER_CLIENT_PATTERN.test(line) && HELPER_CLIENT_KEEP.test(line)) return true;
      return false;
    }

    function isNoise(line) {
      for (const p of NOISE_PATTERNS) if (p.test(line)) return true;
      if (HELPER_CLIENT_PATTERN.test(line) && !HELPER_CLIENT_KEEP.test(line)) return true;
      if (STORAGE_IO_WROTE_PATTERN.test(line) && !STORAGE_IO_KEEP.test(line)) return true;
      return false;
    }

    function filterLogs(lines) {
      return lines.filter(line => {
        if (!line.trim()) return false;
        if (isSignal(line)) return true;
        if (isNoise(line)) return false;
        return true;
      });
    }

    function parseTimestamp(line) {
      const m = line.match(/^(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2}:\d{2})/);
      if (!m) return null;
      return new Date(`${m[1]}T${m[2]}`);
    }

    function parseLevel(line) {
      if (line.includes('[ERROR]')) return 'ERROR';
      if (line.includes('[WARN]')) return 'WARN';
      if (line.includes('[AUDIT]')) return 'AUDIT';
      if (line.includes('[INFO]')) return 'INFO';
      if (line.includes('[DEBUG]')) return 'DEBUG';
      if (line.includes('[TRACE]')) return 'TRACE';
      return 'UNKNOWN';
    }

    function parseSource(line) {
      const m = line.match(/\]\s+(\w+\.\w+:\d+)/);
      return m ? m[1] : '';
    }

    function parseMessage(line) {
      const m = line.match(/\]\s+\w+\.\w+:\d+\s+(.+)$/);
      return m ? m[1] : line;
    }

    function fmtTime(date) {
      if (!date) return '--';
      return date.toLocaleTimeString();
    }

    function fmtDate(date) {
      if (!date) return '--';
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function escapeHtml(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // === PLAIN ENGLISH TRANSLATIONS ===
    function translateToPlainEnglish(msg, level, src) {
      const m = msg.toLowerCase();
      
      // Watchdog / Freezing
      if (m.includes('main_watchdog hit')) 
        return { text: "‚ö†Ô∏è The app froze or became unresponsive", action: "Ask user if app felt slow/frozen. May need to restart the app.", severity: "critical" };
      
      // Helper / Extension
      if (m.includes('helper died') || m.includes('helper crash'))
        return { text: "üîå The browser extension crashed", action: "Ask user to reinstall the browser extension and restart their browser.", severity: "critical" };
      
      // Memory
      if (m.includes('os memory') || m.includes('low memory'))
        return { text: "üíæ Computer is running low on memory (RAM)", action: "User may have too many apps open. Suggest closing unused programs.", severity: "warning" };
      
      // Screenshots
      if (m.includes('uploading screen'))
        return { text: "üì∏ Screenshot was captured and is uploading", action: null, severity: "info" };
      if (m.includes('capture screen'))
        return { text: "üì∏ Taking a screenshot", action: null, severity: "info" };
      if (m.includes('screenshot') && (m.includes('fail') || m.includes('error')))
        return { text: "üì∏ Screenshot failed to capture or upload", action: "Check user's internet connection and screen capture permissions.", severity: "warning" };
      
      // Network errors
      if (m.includes('response: 401') || m.includes('response: 403'))
        return { text: "üîê Authentication failed - user may be logged out", action: "Ask user to log out and log back into Hubstaff.", severity: "critical" };
      if (m.includes('response: 404'))
        return { text: "‚ùì Server couldn't find the requested data", action: "The project or task may have been deleted. Check if it still exists.", severity: "warning" };
      if (m.includes('response: 500') || m.includes('response: 502') || m.includes('response: 503'))
        return { text: "üåê Hubstaff server error occurred", action: "This is a server-side issue. Check status.hubstaff.com for outages.", severity: "critical" };
      if (m.includes('server error'))
        return { text: "üåê Couldn't connect to Hubstaff servers", action: "Check user's internet. If working, check status.hubstaff.com.", severity: "warning" };
      if (m.includes('traffic issue') || m.includes('network error'))
        return { text: "üåê Network connection problem", action: "User may have unstable internet. Ask about WiFi/connection quality.", severity: "warning" };
      if (m.includes('timeout'))
        return { text: "‚è±Ô∏è Request timed out - server took too long", action: "Usually temporary. If persistent, check internet speed.", severity: "warning" };
      
      // Time tracking
      if (m.includes('discard=1') || m.includes('discard=true')) {
        if (m.includes('locked')) return { text: "üîí Time rejected - timesheet is locked/approved", action: "Admin has locked this timesheet. Time cannot be added.", severity: "critical" };
        if (m.includes('future')) return { text: "‚è∞ Time rejected - computer clock is wrong", action: "User's computer clock is set to the future. Fix system time.", severity: "critical" };
        if (m.includes('duplicate')) return { text: "üìã Time rejected - already recorded", action: "This time was already uploaded. No action needed.", severity: "info" };
        return { text: "‚ùå Tracked time was rejected by the server", action: "Check the specific reason. May need manual time entry.", severity: "critical" };
      }
      if (m.includes('resume') && !m.includes('resume_ignored'))
        return { text: "‚ñ∂Ô∏è Tracking resumed after interruption", action: null, severity: "info" };
      if (m.includes('idle') && m.includes('wake'))
        return { text: "üí§ User returned from being idle", action: null, severity: "info" };
      if (m.includes('idle') && !m.includes('wake'))
        return { text: "üí§ User went idle (no activity detected)", action: null, severity: "info" };
      
      // Startup
      if (m.includes('startup') && m.includes('clean'))
        return { text: "‚úÖ App started normally", action: null, severity: "success" };
      if (m.includes('startup') && m.includes('unclean'))
        return { text: "‚ö†Ô∏è App restarted after a crash", action: "Check if time was recovered. Look for RESUME events after this.", severity: "warning" };
      
      // Location / Job Sites
      if (m.includes('locationmanager') || m.includes('locationfeature'))
        return { text: "üìç Location/Job Site feature activity", action: null, severity: "info" };
      if (m.includes('geofence') && m.includes('enter'))
        return { text: "üìç User entered a Job Site location", action: null, severity: "info" };
      if (m.includes('geofence') && m.includes('exit'))
        return { text: "üìç User left a Job Site location", action: "If tracking stopped unexpectedly, this may be why.", severity: "info" };
      if (m.includes('location') && m.includes('denied'))
        return { text: "üìç Location permission was denied", action: "User needs to enable location permissions for Job Sites to work.", severity: "warning" };
      
      // URLs and Apps
      if (m.includes('url:') && m.includes('title:'))
        return { text: "üñ•Ô∏è Recorded active window/website", action: null, severity: "info" };
      if (m.includes('applicationgrabber'))
        return { text: "üñ•Ô∏è Detecting active application", action: null, severity: "info" };
      
      // Generic errors/warnings
      if (level === 'ERROR')
        return { text: "‚ùå An error occurred in the app", action: "Review the technical details below for more context.", severity: "critical" };
      if (level === 'WARN')
        return { text: "‚ö†Ô∏è Something unexpected happened", action: "Usually not critical, but worth noting if issues persist.", severity: "warning" };
      
      return null;
    }

    function generateSummary(data) {
      const findings = [];
      
      // Check for critical issues
      const watchdogHits = data.errors.filter(e => e.msg.toLowerCase().includes('watchdog'));
      if (watchdogHits.length > 0) {
        findings.push({
          severity: 'critical',
          icon: 'ü•∂',
          title: `App Froze ${watchdogHits.length} Time${watchdogHits.length > 1 ? 's' : ''}`,
          description: 'The Hubstaff app became unresponsive and had to recover. This can cause gaps in tracking.',
          action: 'Ask the user if the app felt slow or frozen. They may need to restart Hubstaff or their computer.',
          techDetail: watchdogHits.slice(0,3).map(e => `${fmtTime(e.ts)}: ${e.msg.slice(0,100)}`).join('\n')
        });
      }
      
      const helperCrashes = data.errors.filter(e => e.msg.toLowerCase().includes('helper died') || e.msg.toLowerCase().includes('helper crash'));
      if (helperCrashes.length > 0) {
        findings.push({
          severity: 'critical',
          icon: 'üîå',
          title: 'Browser Extension Crashed',
          description: 'The Hubstaff browser extension stopped working. This affects URL and app tracking.',
          action: 'Have the user reinstall the browser extension and restart their browser.',
          techDetail: helperCrashes.slice(0,3).map(e => `${fmtTime(e.ts)}: ${e.msg.slice(0,100)}`).join('\n')
        });
      }
      
      const serverErrors = data.network.filter(e => e.msg.match(/response:\s*5\d{2}/i));
      if (serverErrors.length > 0) {
        findings.push({
          severity: 'critical',
          icon: 'üåê',
          title: `${serverErrors.length} Server Error${serverErrors.length > 1 ? 's' : ''} Detected`,
          description: 'Hubstaff servers returned errors. This may have prevented data from uploading.',
          action: 'Check status.hubstaff.com for any reported outages during this time period.',
          techDetail: serverErrors.slice(0,3).map(e => `${fmtTime(e.ts)}: ${e.msg.slice(0,100)}`).join('\n')
        });
      }
      
      const authErrors = data.network.filter(e => e.msg.match(/response:\s*(401|403)/i));
      if (authErrors.length > 0) {
        findings.push({
          severity: 'critical',
          icon: 'üîê',
          title: 'Authentication Problems',
          description: 'The user\'s login session may have expired or their permissions changed.',
          action: 'Have the user log out of Hubstaff completely and log back in.',
          techDetail: authErrors.slice(0,3).map(e => `${fmtTime(e.ts)}: ${e.msg.slice(0,100)}`).join('\n')
        });
      }
      
      const discards = data.warnings.filter(e => e.msg.toLowerCase().includes('discard='));
      if (discards.length > 0) {
        const lockedDiscards = discards.filter(e => e.msg.toLowerCase().includes('locked'));
        const futureDiscards = discards.filter(e => e.msg.toLowerCase().includes('future'));
        
        if (lockedDiscards.length > 0) {
          findings.push({
            severity: 'critical',
            icon: 'üîí',
            title: 'Time Rejected - Timesheet Locked',
            description: 'Some tracked time was rejected because the timesheet was already approved/locked.',
            action: 'An admin needs to unlock the timesheet, or time must be added to a different date.',
            techDetail: lockedDiscards.slice(0,3).map(e => `${fmtTime(e.ts)}: ${e.msg.slice(0,100)}`).join('\n')
          });
        }
        if (futureDiscards.length > 0) {
          findings.push({
            severity: 'critical',
            icon: '‚è∞',
            title: 'Time Rejected - Clock Problem',
            description: 'Time was rejected because the computer\'s clock was set incorrectly (in the future).',
            action: 'Have the user check their system date/time settings and enable automatic time.',
            techDetail: futureDiscards.slice(0,3).map(e => `${fmtTime(e.ts)}: ${e.msg.slice(0,100)}`).join('\n')
          });
        }
      }
      
      const memoryIssues = data.warnings.filter(e => e.msg.toLowerCase().includes('memory'));
      if (memoryIssues.length > 0) {
        findings.push({
          severity: 'warning',
          icon: 'üíæ',
          title: 'Low Memory Warnings',
          description: 'The computer was running low on memory (RAM), which can slow down Hubstaff.',
          action: 'Suggest the user close unused programs or browser tabs.',
          techDetail: memoryIssues.slice(0,3).map(e => `${fmtTime(e.ts)}: ${e.msg.slice(0,100)}`).join('\n')
        });
      }
      
      const locationDenied = data.locations.filter(e => e.msg.toLowerCase().includes('denied') || e.msg.toLowerCase().includes('restricted'));
      if (locationDenied.length > 0) {
        findings.push({
          severity: 'warning',
          icon: 'üìç',
          title: 'Location Permission Issues',
          description: 'Location permissions were denied. Job Sites features won\'t work properly.',
          action: 'Have the user enable "Always" location permission for Hubstaff in their device settings.',
          techDetail: locationDenied.slice(0,3).map(e => `${fmtTime(e.ts)}: ${e.msg.slice(0,100)}`).join('\n')
        });
      }
      
      // Positive findings
      if (data.screenshots.length > 0 && !data.screenshots.some(e => e.msg.toLowerCase().includes('fail') || e.msg.toLowerCase().includes('error'))) {
        findings.push({
          severity: 'success',
          icon: 'üì∏',
          title: `${data.screenshots.length} Screenshots Captured`,
          description: 'Screenshots were captured and uploaded successfully during this period.',
          action: null,
          techDetail: null
        });
      }
      
      if (findings.length === 0) {
        findings.push({
          severity: 'success',
          icon: '‚úÖ',
          title: 'No Major Issues Detected',
          description: 'The logs look healthy. No critical errors or warnings were found.',
          action: 'If the user is still experiencing issues, ask for more specific details about what\'s happening.',
          techDetail: null
        });
      }
      
      return findings;
    }

    function hideInfoBox() {
      $('infoBox').style.display = 'none';
      if (selectedMarker) { selectedMarker.style.outline = 'none'; selectedMarker = null; }
    }

    function showInfoBox(e, title, content) {
      const box = $('infoBox');
      $('infoTitle').textContent = title;
      $('infoContent').innerHTML = content;
      box.style.display = 'block';

      const rect = box.getBoundingClientRect();
      let top = e.clientY - rect.height - 15;
      let left = e.clientX - rect.width / 2;
      
      if (top < 10) top = e.clientY + 15;
      if (left < 10) left = 10;
      if (left + rect.width > window.innerWidth - 10) left = window.innerWidth - rect.width - 10;

      box.style.top = top + 'px';
      box.style.left = left + 'px';
    }

    function renderTimeline(data) {
      if (!data || !data.startTime || !data.endTime) {
        $('timelineSection').style.display = 'none';
        return;
      }

      const min = new Date(data.startTime.getTime() - 60000);
      const max = new Date(data.endTime.getTime() + 60000);
      timelineMin = min;
      timelineDur = max - min;

      const pos = ts => ts ? ((ts - min) / timelineDur) * 100 : 0;

      function renderMarkers(items, trackId, cls) {
        const track = $(trackId);
        if (!items.length) { track.innerHTML = ''; return; }
        
        track.innerHTML = items.map((item, i) => {
          const left = pos(item.ts);
          return `<div class="t-marker ${cls}" data-idx="${i}" data-type="${cls}" style="left:${left}%"></div>`;
        }).join('');

        track.querySelectorAll('.t-marker').forEach((el, i) => {
          el.addEventListener('click', e => {
            e.stopPropagation();
            hideInfoBox();
            selectedMarker = el;
            el.style.outline = '2px solid #fff';

            const item = items[i];
            const plainMode = $('plainMode').checked;
            const translation = plainMode ? translateToPlainEnglish(item.msg, item.level, item.src) : null;
            
            let content = `<p><span class="label">Time:</span> ${fmtDate(item.ts)}</p>`;
            if (translation) {
              content += `<p style="color:var(--accent);margin:8px 0;">${translation.text}</p>`;
              if (translation.action) {
                content += `<p style="font-size:11px;color:var(--success);">üí° ${translation.action}</p>`;
              }
            }
            content += `<p><span class="label">Level:</span> ${item.level}</p>`;
            content += `<p><span class="label">Source:</span> ${escapeHtml(item.src || 'N/A')}</p>`;
            content += `<div class="msg">${escapeHtml(item.msg.slice(0, 300))}</div>`;
            
            const titleText = translation ? translation.text.replace(/^[^\s]+\s/, '') : cls.charAt(0).toUpperCase() + cls.slice(1) + ' Event';
            showInfoBox(e, titleText.slice(0, 40), content);
          });
        });
      }

      renderMarkers(data.errors, 'trackErrors', 'error');
      renderMarkers(data.warnings, 'trackWarnings', 'warn');
      renderMarkers(data.screenshots, 'trackScreenshots', 'screenshot');
      renderMarkers(data.network, 'trackNetwork', 'network');
      renderMarkers(data.locations, 'trackLocation', 'location');
      renderMarkers(data.tracking, 'trackTracking', 'tracking');

      $('tlErrorCount').textContent = data.errors.length;
      $('tlWarnCount').textContent = data.warnings.length;
      $('tlScreenCount').textContent = data.screenshots.length;
      $('tlNetCount').textContent = data.network.length;
      $('tlLocCount').textContent = data.locations.length;
      $('tlTrackCount').textContent = data.tracking.length;

      // Time axis
      const axisPoints = 7;
      let axisHtml = '';
      for (let i = 0; i < axisPoints; i++) {
        const t = new Date(min.getTime() + (timelineDur * i / (axisPoints - 1)));
        axisHtml += `<span>${t.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;
      }
      $('timeAxis').innerHTML = axisHtml;

      $('timelineSection').style.display = 'block';
    }

    function analyze(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim());
      allLines = lines;

      const data = {
        total: lines.length,
        errors: [],
        warnings: [],
        screenshots: [],
        network: [],
        locations: [],
        apps: [],
        tracking: [],
        startTime: null,
        endTime: null
      };

      const showDebug = $('showDebug').checked;
      const showTrace = $('showTrace').checked;

      for (const line of lines) {
        const ts = parseTimestamp(line);
        const level = parseLevel(line);
        const src = parseSource(line);
        const msg = parseMessage(line);

        if (ts) {
          if (!data.startTime || ts < data.startTime) data.startTime = ts;
          if (!data.endTime || ts > data.endTime) data.endTime = ts;
        }

        if (!showDebug && level === 'DEBUG') continue;
        if (!showTrace && level === 'TRACE') continue;

        const entry = { ts, level, src, msg, raw: line };

        // Errors
        if (level === 'ERROR' || line.includes('main_watchdog hit') || line.includes('Helper died') || line.includes('crash') || line.includes('FATAL')) {
          data.errors.push(entry);
        }

        // Warnings
        if (level === 'WARN' || line.includes('Discard=') || line.includes('OS Memory') || line.includes('Server Error') || line.includes('traffic issue')) {
          data.warnings.push(entry);
        }

        // Screenshots
        if (line.includes('Uploading Screen') || line.includes('Capture Screen') || line.includes('ScreenData') || line.includes('screenshot') || line.includes('Screenshot')) {
          data.screenshots.push(entry);
        }

        // Network
        if (line.match(/Response:\s*[45]\d{2}/) || line.includes('Server Error') || line.includes('Network') || line.includes('CURL') || line.includes('traffic issue')) {
          data.network.push(entry);
        }

        // Locations
        if (line.includes('feed: sites') || line.includes('LocationFeatureState') || line.includes('LocationManager') || line.includes('geofence') || line.includes('Geofence') || line.includes('Job Site')) {
          data.locations.push(entry);
        }

        // Apps & URLs
        if (line.includes('URL:') || line.includes('TITLE:') || line.includes('APP:') || line.includes('ApplicationGrabber')) {
          data.apps.push(entry);
        }

        // Tracking events
        if (line.includes('Resume') || line.includes('Idle') || line.includes('Discard=') || line.includes('Startup') || line.includes('START_TRACKING') || line.includes('STOP_TRACKING')) {
          data.tracking.push(entry);
        }
      }

      return data;
    }

    function renderLevelTag(level) {
      const cls = level === 'ERROR' ? 'error' : level === 'WARN' ? 'warn' : level === 'AUDIT' ? 'audit' : level === 'INFO' ? 'info' : level === 'DEBUG' ? 'debug' : 'trace';
      return `<span class="tag ${cls}">${level}</span>`;
    }

    function render(data) {
      const plainMode = $('plainMode').checked;
      
      if (!data) {
        $('kpiTotal').textContent = '0';
        $('kpiErrors').textContent = '0';
        $('kpiWarnings').textContent = '0';
        $('kpiScreenshots').textContent = '0';
        $('kpiNetwork').textContent = '0';
        $('kpiTimeSpan').textContent = '--';
        $('errorsList').innerHTML = '<div class="event-item" style="color:var(--muted)">No errors found</div>';
        $('warningsList').innerHTML = '<div class="event-item" style="color:var(--muted)">No warnings found</div>';
        $('screenshotsBody').innerHTML = '';
        $('networkBody').innerHTML = '';
        $('locationsBody').innerHTML = '';
        $('appsBody').innerHTML = '';
        $('trackingBody').innerHTML = '';
        $('searchBody').innerHTML = '';
        $('summaryCard').style.display = 'none';
        return;
      }

      $('kpiTotal').textContent = data.total.toLocaleString();
      $('kpiErrors').textContent = data.errors.length;
      $('kpiWarnings').textContent = data.warnings.length;
      $('kpiScreenshots').textContent = data.screenshots.length;
      $('kpiNetwork').textContent = data.network.length;

      if (data.startTime && data.endTime) {
        const diffMs = data.endTime - data.startTime;
        const hrs = Math.floor(diffMs / 3600000);
        const mins = Math.floor((diffMs % 3600000) / 60000);
        $('kpiTimeSpan').textContent = hrs > 0 ? `${hrs}h ${mins}m` : `${mins}m`;
      } else {
        $('kpiTimeSpan').textContent = '--';
      }

      // Generate and render summary if plain mode
      if (plainMode) {
        const findings = generateSummary(data);
        $('summaryCard').style.display = 'block';
        $('summaryContent').innerHTML = findings.map((f, i) => `
          <div class="summary-item ${f.severity}">
            <h4>${f.icon} ${f.title} ${f.techDetail ? `<span class="show-tech" onclick="toggleTech(${i})">Show technical</span>` : ''}</h4>
            <p>${f.description}</p>
            ${f.action ? `<div class="action">üí° <strong>What to do:</strong> ${f.action}</div>` : ''}
            ${f.techDetail ? `<div class="tech-detail" id="tech-${i}">${escapeHtml(f.techDetail)}</div>` : ''}
          </div>
        `).join('');
      } else {
        $('summaryCard').style.display = 'none';
      }

      // Errors
      if (data.errors.length) {
        $('errorsList').innerHTML = data.errors.slice(0, 100).map(e => {
          const translation = plainMode ? translateToPlainEnglish(e.msg, e.level, e.src) : null;
          return `
            <div class="event-item">
              <div class="event-time">${fmtTime(e.ts)} ${renderLevelTag(e.level)}</div>
              ${translation ? `<div class="plain-explanation">${translation.text}</div>` : ''}
              <div class="event-detail" style="${plainMode ? 'font-size:10px;color:#666;' : ''}">${escapeHtml(e.msg.slice(0, 200))}</div>
              <div class="event-context">${escapeHtml(e.src)}</div>
            </div>
          `;
        }).join('');
      } else {
        $('errorsList').innerHTML = '<div class="event-item" style="color:var(--success)">‚úì No errors found</div>';
      }

      // Warnings
      if (data.warnings.length) {
        $('warningsList').innerHTML = data.warnings.slice(0, 100).map(e => {
          const translation = plainMode ? translateToPlainEnglish(e.msg, e.level, e.src) : null;
          return `
            <div class="event-item">
              <div class="event-time">${fmtTime(e.ts)} ${renderLevelTag(e.level)}</div>
              ${translation ? `<div class="plain-explanation">${translation.text}</div>` : ''}
              <div class="event-detail" style="${plainMode ? 'font-size:10px;color:#666;' : ''}">${escapeHtml(e.msg.slice(0, 200))}</div>
              <div class="event-context">${escapeHtml(e.src)}</div>
            </div>
          `;
        }).join('');
      } else {
        $('warningsList').innerHTML = '<div class="event-item" style="color:var(--success)">‚úì No warnings found</div>';
      }

      // Screenshots
      $('screenshotsBody').innerHTML = data.screenshots.slice(0, 50).map(e => `
        <tr>
          <td>${fmtTime(e.ts)}</td>
          <td>${renderLevelTag(e.level)}</td>
          <td style="font-size:11px;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(e.msg)}</td>
        </tr>
      `).join('') || '<tr><td colspan="3" style="color:var(--muted)">No screenshot events found</td></tr>';

      // Network
      $('networkBody').innerHTML = data.network.slice(0, 50).map(e => {
        let statusCls = 'info';
        if (e.msg.match(/Response:\s*[45]\d{2}/)) statusCls = 'error';
        else if (e.msg.includes('Error')) statusCls = 'error';
        return `
          <tr>
            <td>${fmtTime(e.ts)}</td>
            <td><span class="tag ${statusCls}">${e.level}</span></td>
            <td style="font-size:11px;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(e.msg)}</td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="3" style="color:var(--muted)">No network issues found</td></tr>';

      // Locations
      $('locationsBody').innerHTML = data.locations.slice(0, 50).map(e => `
        <tr>
          <td>${fmtTime(e.ts)}</td>
          <td>${renderLevelTag(e.level)}</td>
          <td style="font-size:11px;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(e.msg)}</td>
        </tr>
      `).join('') || '<tr><td colspan="3" style="color:var(--muted)">No location events found</td></tr>';

      // Apps
      $('appsBody').innerHTML = data.apps.slice(0, 50).map(e => {
        let type = 'App';
        if (e.msg.includes('URL:')) type = 'URL';
        else if (e.msg.includes('TITLE:')) type = 'Title';
        return `
          <tr>
            <td>${fmtTime(e.ts)}</td>
            <td><span class="tag info">${type}</span></td>
            <td style="font-size:11px;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(e.msg)}</td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="3" style="color:var(--muted)">No app/URL events found</td></tr>';

      // Tracking
      $('trackingBody').innerHTML = data.tracking.slice(0, 50).map(e => {
        let eventType = 'Event';
        if (e.msg.includes('Resume')) eventType = 'Resume';
        else if (e.msg.includes('Idle')) eventType = 'Idle';
        else if (e.msg.includes('Discard')) eventType = 'Discard';
        else if (e.msg.includes('Startup')) eventType = 'Startup';
        else if (e.msg.includes('START_TRACKING')) eventType = 'Start';
        else if (e.msg.includes('STOP_TRACKING')) eventType = 'Stop';
        const typeCls = eventType === 'Discard' ? 'warn' : eventType === 'Resume' ? 'success' : 'info';
        return `
          <tr>
            <td>${fmtTime(e.ts)}</td>
            <td><span class="tag ${typeCls}">${eventType}</span></td>
            <td style="font-size:11px;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(e.msg)}</td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="3" style="color:var(--muted)">No tracking events found</td></tr>';

      // Render timeline
      renderTimeline(data);
    }

    function search(query) {
      if (!query.trim()) {
        $('searchBody').innerHTML = '<tr><td colspan="4" style="color:var(--muted)">Enter a search term above</td></tr>';
        return;
      }

      const q = query.toLowerCase();
      const results = allLines.filter(line => line.toLowerCase().includes(q)).slice(0, 200);

      if (!results.length) {
        $('searchBody').innerHTML = `<tr><td colspan="4" style="color:var(--muted)">No results for "${escapeHtml(query)}"</td></tr>`;
        return;
      }

      $('searchBody').innerHTML = results.map(line => {
        const ts = parseTimestamp(line);
        const level = parseLevel(line);
        const src = parseSource(line);
        const msg = parseMessage(line);
        const highlightedMsg = escapeHtml(msg).replace(new RegExp(`(${escapeHtml(query)})`, 'gi'), '<mark class="highlight">$1</mark>');
        return `
          <tr>
            <td style="white-space:nowrap;">${fmtTime(ts)}</td>
            <td>${renderLevelTag(level)}</td>
            <td style="font-size:10px;color:var(--muted);max-width:100px;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(src)}</td>
            <td style="font-size:11px;">${highlightedMsg}</td>
          </tr>
        `;
      }).join('');
    }

    $('analyzeBtn').onclick = () => {
      const text = $('logInput').value;
      if (!text.trim()) {
        $('status').textContent = 'Please paste log content first';
        $('status').className = 'status error';
        return;
      }

      let lines = text.split(/\r?\n/);
      const originalCount = lines.filter(l => l.trim()).length;
      
      if ($('autoFilter').checked) {
        lines = filterLogs(lines);
        const filteredCount = lines.length;
        const removedCount = originalCount - filteredCount;
        const pct = originalCount > 0 ? ((removedCount / originalCount) * 100).toFixed(1) : 0;
        $('filterStats').style.display = 'block';
        $('filterStatsText').innerHTML = `üîÆ <strong>Filtered:</strong> ${originalCount.toLocaleString()} ‚Üí ${filteredCount.toLocaleString()} lines (removed ${removedCount.toLocaleString()} noise lines, ${pct}%)`;
      } else {
        $('filterStats').style.display = 'none';
      }

      parsedData = analyze(lines.join('\n'));
      render(parsedData);
      $('status').textContent = `Analyzed ${parsedData.total.toLocaleString()} lines`;
      $('status').className = 'status success';
    };

    $('clearBtn').onclick = () => {
      $('logInput').value = '';
      $('searchInput').value = '';
      allLines = [];
      parsedData = null;
      timelineMin = null;
      timelineDur = null;
      render(null);
      $('timelineSection').style.display = 'none';
      $('filterStats').style.display = 'none';
      hideInfoBox();
      $('status').textContent = 'üîí All data cleared';
      $('status').className = 'status success';
      setTimeout(() => { $('status').textContent = ''; }, 2000);
    };

    $('searchBtn').onclick = () => search($('searchInput').value);
    $('searchInput').onkeydown = e => { if (e.key === 'Enter') search($('searchInput').value); };
    $('clearSearchBtn').onclick = () => {
      $('searchInput').value = '';
      $('searchBody').innerHTML = '<tr><td colspan="4" style="color:var(--muted)">Enter a search term above</td></tr>';
    };

    $('showDebug').onchange = () => { if (parsedData) { parsedData = analyze($('logInput').value); render(parsedData); } };
    $('showTrace').onchange = () => { if (parsedData) { parsedData = analyze($('logInput').value); render(parsedData); } };
    $('plainMode').onchange = () => { if (parsedData) render(parsedData); };

    // Toggle technical details in summary
    window.toggleTech = function(idx) {
      const el = $('tech-' + idx);
      if (el) el.classList.toggle('visible');
    };

    $('helpBtn').onclick = () => $('helpModal').classList.add('visible');
    $('closeHelp').onclick = () => $('helpModal').classList.remove('visible');
    $('helpModal').onclick = e => { if (e.target === $('helpModal')) $('helpModal').classList.remove('visible'); };

    // Timeline zoom controls
    $('zoomSlider').oninput = function() {
      $('timelineContent').style.width = (this.value * 100) + '%';
    };

    $('resetZoom').onclick = () => {
      $('zoomSlider').value = 1;
      $('timelineContent').style.width = '100%';
      $('timelineContainer').scrollLeft = 0;
      hideInfoBox();
    };

    // Close info box on click outside
    document.addEventListener('click', e => {
      if (!e.target.closest('.info-box') && !e.target.closest('.t-marker')) {
        hideInfoBox();
      }
    });

    // Timeline track toggles
    const trackToggles = [
      { toggle: 'togErrors', label: 'labelErrors', track: 'trackErrors' },
      { toggle: 'togWarnings', label: 'labelWarnings', track: 'trackWarnings' },
      { toggle: 'togScreenshots', label: 'labelScreenshots', track: 'trackScreenshots' },
      { toggle: 'togNetwork', label: 'labelNetwork', track: 'trackNetwork' },
      { toggle: 'togLocation', label: 'labelLocation', track: 'trackLocation' },
      { toggle: 'togTracking', label: 'labelTracking', track: 'trackTracking' },
    ];

    trackToggles.forEach(({ toggle, label, track }) => {
      $(toggle).onchange = function() {
        const isVisible = this.checked;
        $(label).classList.toggle('hidden', !isVisible);
        $(track).classList.toggle('hidden', !isVisible);
        this.parentElement.classList.toggle('disabled', !isVisible);
      };
    });

    document.addEventListener('keydown', e => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        $('analyzeBtn').click();
      }
    });
  </script>
</body>
</html>
